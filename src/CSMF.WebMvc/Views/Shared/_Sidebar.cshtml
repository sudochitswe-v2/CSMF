@using CSMF.WebMvc.Domain.Entities.Users
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using System.Text.Json
@using static CSMF.WebMvc.Models.NavGroupExtentions;

@inject UserManager<SystemUser> _userManager
@inject SignInManager<SystemUser> _signInManager
@{
    bool ShouldShow(string controller)
    {
        var currentController = ViewContext.RouteData.Values["Controller"]?.ToString() ?? string.Empty;
        return controller == currentController;
    }

    bool ShouldActive(string action, string controller)
    {
        var currentController = ViewContext.RouteData.Values["Controller"]?.ToString() ?? string.Empty;
        var currentAction = ViewContext.RouteData.Values["Action"]?.ToString() ?? string.Empty;
        return action == currentAction && controller == currentController;
    }

    var navigation = GetDefaultNavData();
}

<div class="accordion" id="sidebarAccordion">
    @foreach (var item in navigation.Items)
    {
        if (!item.IsAccordion)
        {
            <a class="nav-link text-secondary @(ShouldActive(item.Action, item.Controller) ? "fw-bold text-dark text-decoration-underline" : "") py-3 px-3"
               asp-controller="@item.Controller" asp-action="@item.Action">
                <i class="bi @item.Icon me-2"></i>@item.Title
            </a>
        }
        else
        {
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading@(item.Controller)">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse@(item.Controller)" aria-expanded="false"
                            aria-controls="collapse@(item.Controller)">
                        <i class="bi @item.Icon me-2"></i> @item.Title
                    </button>
                </h2>
                <div id="collapse@(item.Controller)" class="accordion-collapse collapse @(ShouldShow(item.Controller) ? "show" : "")"
                     aria-labelledby="heading@(item.Controller)" data-bs-parent="#sidebarAccordion">
                    <div class="accordion-body p-0">
                        <div class="nav flex-column">
                            @foreach (var child in item.Children)
                            {
                                <a class="nav-link text-secondary @(ShouldActive(child.Action, item.Controller) ? "fw-bold text-dark text-decoration-underline" : "") py-2 px-4"
                                   asp-controller="@item.Controller" asp-action="@child.Action">
                                    <i class="bi @child.Icon me-2"></i> @child.Title
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }

    @if (User is not null && User.Identity.IsAuthenticated)
    {
        <!-- User Profile -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingUserProfile">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUserProfile" aria-expanded="false" aria-controls="collapseUserProfile">
                    <i class="bi bi-person me-2"></i> @User.Identity.Name
                </button>
            </h2>
            <div id="collapseUserProfile" class="accordion-collapse collapse @(ShouldShow("Account") ? "show" : "")" aria-labelledby="headingUserProfile" data-bs-parent="#sidebarAccordion">
                <div class="accordion-body p-0">
                    <div class="nav flex-column">
                        <a class="nav-link text-secondary @(ShouldActive("WhoAmI", "Account") ? "fw-bold text-dark text-decoration-underline" : "") py-2 px-4" asp-controller="Account" asp-action="WhoAmI">WhoAmI?</a>
                        <form asp-controller="Account" asp-action="Logout" method="post" id="logoutForm" class="form-inline">
                            <button type="submit" class="btn btn-link nav-link text-danger py-3 px-3 w-100 text-start">
                                <i class="bi bi-box-arrow-right me-2"></i> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>