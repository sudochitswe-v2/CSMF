@model PaginatedSearchResult<LoanApplicationReadViewModel>
@{
    ViewData["Title"] = "Loan Applications";
}

<div class="container mt-4">
    <!-- Search + New Button -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <form method="get" asp-action="Index" class="w-75">
            <div class="input-group">
                <input name="search" value="@Model.SearchTerm" placeholder="Search by customer or Loan No." class="form-control" />
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </div>
        </form>

        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-journal-plus me-2"></i>New Application
        </a>
    </div>

    <!-- Page Size Dropdown -->
    <div class="mb-3">
        <label for="pageSize" class="form-label">Items per page:</label>
        <select id="size" class="form-select w-auto d-inline-block"
                asp-items="@(new List<SelectListItem>
                {
                    new SelectListItem { Value = "5", Text = "5" },
                    new SelectListItem { Value = "10", Text = "10", Selected = Model.PageSize == 10 },
                    new SelectListItem { Value = "25", Text = "25", Selected = Model.PageSize == 25 },
                    new SelectListItem { Value = "50", Text = "50", Selected = Model.PageSize == 50 }
                })"
                onchange="changePageSize(this.value)">
        </select>
    </div>

    <!-- Loan Applications Table -->
    @if (Model.Items.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Loan No.</th>
                        <th>Customer</th>
                        <th>Status</th>
                        <th>Principal</th>
                        <th>Release Date</th>
                        <th>Created By</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var loan in Model.Items)
                    {
                        <tr>
                            <td>@loan.Id</td>
                            <td>@loan.Customer.FullName</td>
                            <td>
                                @{
                                    string bg = loan.Status switch
                                    {
                                        nameof(DefinedLoanApplicationStatus.Requested) => "bg-info",
                                        nameof(DefinedLoanApplicationStatus.Active) => "bg-success",
                                        nameof(DefinedLoanApplicationStatus.Denied) => "bg-danger",
                                        nameof(DefinedLoanApplicationStatus.Defaulted) => "bg-warning",
                                    };
                                }
                                <span class="badge @bg">@loan.Status</span>
                            </td>
                            <td>@loan.PrincipalAmount.ToString("N0")</td>
                            <td>@loan.ReleaseDate.ToString("dd/MMMM/yyyy")</td>
                            <td>@loan.CreatedBy</td>

                            <td class="text-end">
                                <!-- Details Button -->
                                <a asp-action="Detail" asp-route-id="@loan.Id"
                                   class="btn btn-sm btn-outline-success me-2"
                                   title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <!-- Delete Form -->
                                <form id="delete-form-@loan.Id" asp-action="Delete" asp-route-id="@loan.Id" method="post" class="d-inline">
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                            onclick="confirmDelete('@loan.Id','Loan #@loan.Id')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination & Page Size Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                Showing @Model.Items.Count() of @Model.TotalItems applications
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    @{
                        var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
                        var nextDisabled = !Model.HasNextPage ? "disabled" : "";
                        var currentSearch = ViewData["SearchTerm"]?.ToString() ?? "";
                    }

                    <li class="page-item @prevDisabled">
                        <a class="page-link" asp-action="Index"
                           asp-route-pageNumber="@(Model.PageNumber - 1)"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-searchTerm="@currentSearch">
                            Previous
                        </a>
                    </li>

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                            <a class="page-link" asp-action="Index"
                               asp-route-pageNumber="@i"
                               asp-route-pageSize="@Model.PageSize"
                               asp-route-searchTerm="@currentSearch">
                                @i
                            </a>
                        </li>
                    }

                    <li class="page-item @nextDisabled">
                        <a class="page-link" asp-action="Index"
                           asp-route-pageNumber="@(Model.PageNumber + 1)"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-searchTerm="@currentSearch">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center mt-3">No applications found.</div>
    }

    <!-- Back Button -->
    <div class="mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

@section Scripts {
    <script>
        //function confirmDelete(id) {
        //    if (confirm('Are you sure you want to delete this application?')) {
        //        document.getElementById('delete-form-' + id).submit();
        //    }
        //}

        function changePageSize(size) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('size', size);
            urlParams.set('page', 1); // Reset to first page
            window.location.search = urlParams.toString();
        }

        // Initialize tooltip
        document.addEventListener("DOMContentLoaded", function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipEl) {
                return new bootstrap.Tooltip(tooltipEl);
            });
        });
    </script>
}